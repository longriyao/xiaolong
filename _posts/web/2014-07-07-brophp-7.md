---
layout: post
title: Brophp教程笔记7-多搜索加分页
description: ""
categories: [web]
tags: [php]
---
#多搜索加分页
##pV(入口视图)
[admin/views/default/index/menu.tpl]

    <li> <h3>商品管理</h3> 
         <ul>
             <li><a href="<{$app}>/goods/add"  target="right">添加商品</a></li>
             <li><a href="<{$app}>/goods" target="right">编辑商品</a></li>
             <li><a href="<{$app}>/goods/ser" target="right">搜索商品</a></li>
         </ul>
    <li>    
    
访问goods模块下的ser操作。

##vC
[admin/controls/goods.class.php (ser)]
分配一个下拉模块，显示视图

		function ser() {
			$this->assign("select", D('cat')->selectform('cid'));
			$this->display();
		}

##mV（处理部分的视图）
[admin/views/default/goods/ser.tpl]
提交表单到编辑页面。

    <{include "public/header.tpl"}>
    <h1>搜索商品</h1>
    <form action="<{$url}>/index" method="post">
        商品分类：<{$select}> <br>
        商品名称：<input type="text" name="name" /> <br>
        商品价格：<input type="text" size="10" name="minprice" />
              -
              <input type="text" size="10" name="maxprice" />
        <br>
        <input type="submit" value="搜索">
    </form>
    <{include "public/footer.tpl"}>
    
传递的参数：
<{$select}> 里的cid //商品分类
$_POST['name']
$_POST['minprice']
$_POST['maxprice']

##mC
目的1：根据关键词进行搜索。 实现方式：组合where条件。使用数组形式的where条件。根据关键词的数量进行相应组合。
[admin/controls/goods.class.php (index)]

		function index() {
			$where =array();
			$arr=$_POST;
			if(!empty($arr['cid']) && $arr['cid'] != '0') {
				$where['cid']=$arr['cid'];
			} 
			if(!empty($arr['name'])) {
				$where['name']="%{$arr['name']}%";
			}
			if(!empty($arr['minprice'])) {
				$where['price >']=$arr['minprice'];
			}
			if(!empty($arr['maxprice'])) {
				$where['price <']=$arr['maxprice'];
			}
			
			$goods = D('goods');
			$page = new Page($goods->total($where), 10, $nextpage);
			$this->assign('goods', $goods->field('id, name, price, num, ptime')->limit($page->limit)->select($where));
			$this->assign('fpage', $page->fpage());
			$this->assign('page', $page->page);
			$this->display(); 
		}

目的2：操作优化，跳转页面时附带传参。
[admin/controls/goods.class.php (index)]
此时有两中传参方式 post和get所以要处理一下。 $arr=!empty($_POST) ? $_POST : $_GET;

		function index() {
			
			$where =array();
			$arr=!empty($_POST) ? $_POST : $_GET;
			$nextpage="";
			if(!empty($arr['cid']) && $arr['cid'] != '0') {
				$where['cid']=$arr['cid'];
				$nextpage .= "/cid/{$arr['cid']}";
				$mess .="类别为：{$arr['cid']}中的 ";
			} 
			if(!empty($arr['name'])) {
				$where['name']="%{$arr['name']}%";
				$nextpage .="/name/{$arr['name']}";
			}
			if(!empty($arr['minprice'])) {
				$where['price >']=$arr['minprice'];
				$nextpage .="/minprice/{$arr['minprice']}";
			}
			if(!empty($arr['maxprice'])) {
				$where['price <']=$arr['maxprice'];
				$nextpage .= "/maxprice/{$arr['maxprice']}";
			}
			$goods = D('goods');
			//$nextpage是页码参数，采用get方法传递。
			$page = new Page($goods->total($where), 10, $nextpage);

			$this->assign('goods', $goods->field('id, name, price, num, ptime')->limit($page->limit)->select($where));
			$this->assign('fpage', $page->fpage());
			$this->assign('page', $page->page);
			$this->display(); 
		}

##目的3：操作优化，在编辑页面提示所选关键词。
[admin/controls/goods.class.php (index)]

		function index() {
			
			$where =array();

			$arr=!empty($_POST) ? $_POST : $_GET;

			$mess="";
			$nextpage="";
			if(!empty($arr['cid']) && $arr['cid'] != '0') {
				$where['cid']=$arr['cid'];
				$nextpage .= "/cid/{$arr['cid']}";
				$mess .="类别为：{$arr['cid']}中的 ";
			} 

			if(!empty($arr['name'])) {
				$where['name']="%{$arr['name']}%";
				$nextpage .="/name/{$arr['name']}";
				$mess .="商品名称中有 {$arr['name']}的 ";
			}

			if(!empty($arr['minprice'])) {
				$where['price >']=$arr['minprice'];
				$nextpage .="/minprice/{$arr['minprice']}";
				$mess .="价格大于 {$arr['minprice']}的 ";
			}

			if(!empty($arr['maxprice'])) {
				
				$where['price <']=$arr['maxprice'];
				$nextpage .= "/maxprice/{$arr['maxprice']}";
				$mess .="价格小于 {$arr['maxprice']} 的";
			}

            //打印到编辑页面。
			p($mess, $nextpage);
		//	p($where);
			$goods = D('goods');
			$page = new Page($goods->total($where), 10, $nextpage);

			$this->assign('goods', $goods->field('id, name, price, num, ptime')->limit($page->limit)->select($where));

			$this->assign('fpage', $page->fpage());

			$this->assign('page', $page->page);

			$this->display(); 
		}



