---
layout: post
title: Brophp教程笔记6-无限分类下
description: ""
categories: [web]
tags: [php]
---
#无限分类下
[admin/views/default/index/menu.tpl]

    <li> <h3>分类管理</h3> 
     <ul>
        <li><a href="<{$app}>/cat/add" target="right">添加分类</a></li>
        <li><a href="<{$app}>/cat" target="right">编辑分类</a></li>
     </ul>
     
在首页点击编辑分类即可进入分类控制器[admmin/cat]。

##查询分类（编辑分类）
###C
[admin/controls/cat.class.php (index)]
		//编辑分类
		function index() {
			$data = D("cat")->field('id, concat(path, "-", id) as abspath, name')->order('abspath,id')->select();
			$this->assign("data", $data);
			$this->display();
		}

###V
[admin/views/default/cat/index.tpl]

    <{include "public/header.tpl"}>
    <h1>分类列表</h1>
    <ul style="list-style:none;margin:0px;padding:0px">
        <{foreach $data as $row}>
            <{$space=str_repeat("|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;", count(explode("-", $row.abspath))-2)}>
            <li> <{$space}>|-<{$row.name}> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="<{$url}>/mod/id/<{$row.id}>">修改</a>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a onclick="return confirm('你确定要删除分类<{$row.name}>吗?')" href="<{$url}>/del/id/<{$row.id}>">删除</a></li> 
        <{/foreach}>
    </ul>
    <{include file="public/footer.tpl"}>
    
//在模板中使用php函数，产生缩进

    <{$space=str_repeat("|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;", count(explode("-", $row.abspath))-2)}>


##添加分类
###vC
[admin/controls/cat.class.php (add)]

		function add() {
			$this->assign("select", D('cat')->selectform());//selectform(name名称默认PID,选中的选项默认为零)
			$this->display();
		}

###V
[admin/views/default/cat/add.tpl]

    <{include "public/header.tpl"}>
    <form action="<{$url}>/insert" method="post">
        上层分类：<{$select}><br>
        分类名称：<input type="text" name="name" value="" /><br>
        <input type="submit" value="添加分类">
    </form>
    <{include "public/footer.tpl"}>

POST中的数据有 pid name

###mC
[admin/controls/cat.class.php (insert)]
目的：组合出与cat数据表相同的数据，存到$_POST[]数组中，插入到数据库（id pid path name）
步骤：1 id pid name 已经有了。只需要组合出path 而子类的path是父类的abspath，故可以通过pid获取数据组合出来。

		function insert() {     
			$cats = D('cat');
			if($_POST['pid']=="0") {//根路径特殊处理
				$_POST['path']="0";
			} else {
				$cat = $cats->find($_POST['pid']);
				$_POST["path"] = $cat['path'].'-'.$_POST['pid']; //父类的abspath 即为新增分类的path
			}
			if($cats -> insert()) {
				$this->success("分类添加成功!", 1, "index");
			} else {
				$this -> error("添加分类失败", 3, "add");
			}
		}


##修改分类
###pV(操作入口父视图)
[admin/views/default/cat/index.tpl]

    <li> <{$space}>|-<{$row.name}> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="<{$url}>/mod/id/<{$row.id}>">修改</a>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a onclick="return confirm('你确定要删除分类<{$row.name}>吗?')" href="<{$url}>/del/id/<{$row.id}>">删除</a></li> 

传递数据：$_GET['id']
###vC
[admin/controls/cat.class.php (cat)]

		function mod() {
			$catobj = D("cat");
			$cat = $catobj -> find($_GET['id']);
			//name名称pid，默认选择$cat['pid']
			$this->assign('select', $catobj->selectform('pid', $cat['pid']));
			$this->assign($cat);
			$this->display();
		}

传递数据：
<{select}>//下拉表单 name名称pid，默认选择$cat['pid']
<{cat}>// 待修改分类的所有字段 <{id}> <{pid}> <{path}> <{name}>
###V
[admin/views/default/cat/mod.tpl]  与添加视图基本一致

    <{include "public/header.tpl"}>
    <h1>修改分类</h1>
    <form action="<{$url}>/update" method="post">
        上层分类：<{$select}><br>
              <input type="hidden" name="id" value="<{$id}>">
        分类名称：<input type="text" name="name" value="<{$name}>" /><br>
        <input type="submit" value="修改分类">
    </form>
    <{include "public/footer.tpl"}>

传递数据：
$_POST['pid']  //<{$select}>内部的name默认为pid
$_POST['id']  //隐藏表单传递
$_POST['name']//修改后的分类名称

###mC
[admin/controls/cat.class.php (update)]
目的1：更新分类表单数据。
实现方式：组合出表单字段插入数据库。id pid name 已经有了。难点是path
根据path公式： //旧的本身节点的path=旧父节点的abspath; 那么 //新的本身节点的path=新父节点的abspath;

目的2：优化操作	不能将自己移动到自己的子类别中
实现方式：分析：我们移动的方式是通过选择父类来实现的。所以解决方案转化为不能让新选择的父类为自己的子类。问题：根据处理特殊情况的原则，如何判断选择的父类为自己的子类？ 方案：如果本身的id在所新的父类的path中就为真。 


目的3：优化操作	移动分类时，将子分类也一起分过去
实现方式：
    分析：移动的方式是 /新的本身节点的path=新父节点的abspath;
        将子分类也移动过去：/新子节点的path=新的本身节点的abspath=新的本身节点的path+本身id =新父节点的abspath+本身id
        
		    //旧的本身节点的abspath ==（替换为）===	新的本身节点的abspath
		//即：旧的子节点的path      == (替换为) === 新的子节点的path
			$cat->where("path like '{$srcpath}%'") -> update("path=replace(path, '{$srcpath}', '{$cpath}')");

		function update() {
			$cat = D("cat");
			//取出两目录(一个是新选择的PATH)
			$data1 = $cat->field('path')->find($_POST['pid']);
			$ppath = $data1['path']; //新的父节点的path;
			$data2 = $cat->field('path')->find($_POST['id']);
			$xpath = $data2['path']; //旧的本身节点的path=旧父节点的abspath;

			//新的父节点的abspath=新的本身节点的path 
			if($_POST['pid'] == 0) {
				$_POST['path']=0;
			} else {
				$_POST["path"] = $ppath."-".$_POST['pid'];//新的本身节点的path=新的父节点的abspath
			}
		
			//不能将自己移动到自己的子类别中
			if(in_array($_POST['id'], explode("-", $_POST['path']))) {
				$this->error("不能将{$_POST['name']}移动到自己或自己的子分类中");
			}
			
	        //旧的本身节点的path+id=旧的本身节点的abspath
			$srcpath= $xpath.'-'.$_POST['id']; 
			//新的本身节点的path+id=新的本身节点的abspath
			$cpath = $_POST['path'].'-'.$_POST['id']; 

			//所有子分类一起更新
		    //旧的本身节点的abspath ==（替换为）===	新的本身节点的abspath
		//即：旧的子节点的path      == (替换为) === 新的子节点的path
			$cat->where("path like '{$srcpath}%'") -> update("path=replace(path, '{$srcpath}', '{$cpath}')");

			if($cat->update()) {
				$this->success('修改成功!', 1, "index");
			} else {
				$this -> error('修改失败！', 3, "cat/mod/id/{$_POST['id']}");
			}
		}

##删除分类
###pV(操作入口父视图)
[admin/views/default/cat/index.tpl]

    <li> <{$space}>|-<{$row.name}> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="<{$url}>/mod/id/<{$row.id}>">修改</a>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a onclick="return confirm('你确定要删除分类<{$row.name}>吗?')" href="<{$url}>/del/id/<{$row.id}>">删除</a></li> 

传递参数：
$_GET['id'] //

###C
[admin/controls/cat.class.php (del)]
目的1：删除分类  实现方式： $cat -> delete($_GET['id'])
目的2：优化操作 有子分类不能删： 分析：如何判断有子分类？ 方案：把本身id作为pid进行查询，如果能查询到数据说明有子分类。 $cat->total(array('pid'=>$_GET['id'])) > 0 

目的3：优化操作 分类下有商品不能删：分析：如何判断子类是否有商品？方案：本身id作为商品的cid进行查询，如果有数据说明有商品。

		function del() {
			$cat = D("cat");
			if($cat->total(array('pid'=>$_GET['id'])) > 0 ) {
				$this->error("当前分类下有子类，不能删除!", 3, "index");
			}
//			p($_GET['id']);
			if(D('goods')->total(array('cid'=>$_GET['id'])) > 0) {
				$this->error("当前分类下有商品， 不能删除", 3, "index");
			}

			if($cat -> delete($_GET['id'])) {
				$this->success("删除成功", 1, "index");
			} else {
				$this->error("删除失败", 3, "index");
			} 
		}
