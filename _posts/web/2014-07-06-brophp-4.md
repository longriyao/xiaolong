---
layout: post
title: Brophp教程笔记4-后台管理系统商品管理模块(下)
description: ""
categories: [web]
tags: [php]
---

#商品管理模块优化：
##验证功能

###C：（controls）
控制器部分必须开启验证。开启方法如下:

[admin/controls/goods.class.php (insert)]
	function insert() {
			
			$goods = D("goods"); //初始化goods表模块
		
			$_POST['ptime'] = time();

			if($goods->insert($_POST, 1, 1)) { //最后一个参数 1 为开启验证功能。
				$this->success("添加商品成功!", 1, "index");
			} else {
				$this->error($goods->getMsg(), 3, "add");
			}
		}


难道这就开启验证功能了？当然不是，控制器里根本没见一个具体的验证操作的影子。想要实现验证还需要Model的配合。为什么呢？因为验证是一个处理过程，根据MVC思想它应该写在Model里。

    $goods = D("goods"); //初始化goods表模块


###M：（Model）
上面这条语句再与goods.xml配合即可实现。
[admin/models/goods.xml]

    <?xml version="1.0" encoding="utf-8" ?>
    <form>
        <input name="name" type="notnull" msg="商品名称不能为空!" />
        <input name="price" type="notnull" msg="商品价格不能为空!" />
        <input name="num" type="notnull" msg="商品数量不能为空!" />
        <input name="desn" type="notnull" msg="商品介绍不能为空!" />
        <input name="price" type="currency" msg="商品价格必须为金钱格式!" />
        <input name="num" type="number" msg="商品数量必须是数字格式!" />
    </form>	
    
这里要注意的是 Model 里面主要写与表有关的操作。且文件名要与表明相同。xml文档的作用相当于一个配置文件。配置各种验证操作的具体设置。

这样一来 $this->error($goods->getMsg(), 3, "add"); //getMsg获取的就是xml文件里相应的msg。

##图片上传功能
###Views
首先表单视图部分必须修改如下：
[admin/views/default/goods/add.tpl]

    <form action="<{$url}>/insert" enctype="multipart/form-data" method="post">
    
表单中enctype="multipart/form-data"的意思，是设置表单的MIME编码。默认情况，这个编码格式是application/x-www-form-urlencoded，不能用于文件上传；只有使用了multipart/form-data，才能完整的传递文件数据，enctype="multipart/form-data"是上传二进制数据; form里面的input的值以2进制的方式传过去。
form里面的input的值以2进制的方式传过去，所以request就得不到值了。 也就是说加了这段代码,用request就会传递不成功,取表单值加入数据库时，用到...

###Model
由于图片上传的特殊性。文件操作一般单独拿出来写一个独立的model,文件上传的处理过程与表无关，所以我们可以选择把这个功能写在全局类或者全局函数中。
此处我们写在全局函数里。
[commons/functions.inc.php]

    <?php
	//全局可以使用的通用函数声明在这个文件中.
	
	function upload() {
		$up = new FileUpload(); //文件上传类，与翻页类一样相当于插件。
		$up -> set('thumb', array('width'=>400, 'height'=>400)); //缩放图片
		$up -> set('watermark', array('water'=>'./public/images/bbs.gif', 'position'=>5));//水印图片
		if($up->upload('uppic')) {
			$filename =  $up->getFileName();
			
			$img = new Image();

			$img -> thumb($filename, 120,120, 'th_');//如果上传成功，新建图片处理类，对保存一份缩略图
			return array(true, $filename);//返回真值和文件名
		} else {
		//返回假值和错误信息
			return array(false, $up->getErrorMsg());
		}
	}
	
    function delpic($filename) {
		$file="./public/uploads/".$filename;
	
		if(file_exists($file)) {
			unlink($file);
		}

		$file2="./public/uploads/th_".$filename;

		if(file_exists($file2)) {
			unlink($file2);
		}

	}

	
	function delmulpic($filenames) {
		
		foreach($filenames as $filename) {
			delpic($filename['pic']);
		}

	}

控制器中可以直接使用此函数进行上传图片处理。
###Controls
[admin/controls/goods.class.php (insert)]

		function insert() {
			
			$goods = D("goods");
		
			$_POST['ptime'] = time();
		
			$up = upload(); //commons/functions.inc.php 里的全局函数 
            if($up[0]) { //如果为真up[1]传递的是文件名
				$_POST['pic'] = $up[1]; 
			} else {  //如果为假up[1]传递的是错误信息
				$this->error($up[1], 3, "add");
			}

			if($goods->insert($_POST, 1, 1)) {
				$this->success("添加商品成功!", 1, "index");
			} else { //上传成功修改失败（例如忘了些商品名字）必须删掉已经上传的图片。
				if($up[0]) {//在失败的条件中判断是否上传成功，或者在成功的条件中判断是否上传失败 
					delpic($up[1]);//调用全局函数
				}
				$this->error($goods->getMsg(), 3, "add");
			}
		}

##修改数据时的图片操作：
[admin/controls/goods.class.php]

	function update() {
			$goods = D("goods");
            //如果文件符合要求
			if($_FILES['uppic']['error']==0) {
				$up = upload();//上传
				if($up[0]) {//上传成功则保存文件名
					$_POST['pic'] = $up[1];
				} else {
				    //上传失败发送错误信息，跳转
					$this->error($up[1], 3, "add");
				}
			}

			if($goods -> update($_POST, 1, 1)) {
				if($up[0]) { //更新成功且上传成功，删除旧图片
				    // <input type="hidden" name="dpic" value="<{$pic}>"> 
					delpic($_POST['dpic']);
				}

				$this->success("修改成功!", 1, "index");
			} else {
			            //更新失败且上传成功删除图片
				if($up[0]) {
					delpic($up[1]);
				}

				$this->error($goods->getMsg(), 3, "goods/mod/id/{$_POST['id']}");
			}
		}

##删除数据时的图片操作
[admin/controls/goods.class.php（del）]

		function del() {
			
			$goods = D("goods");

	
		//	p($_GET['id'], $_POST['id']);

			$id = !empty($_POST['id']) ? $_POST['id'] : $_GET['id'];
			

			$filenames = $goods->field('pic')->where($id)->select();
		    //如果删除数据成功，删除图片	
			if($goods->where($id)->delete()) {
				delmulpic($filenames);
			//重定向到当前页，必须在views中传参数代码如下
				$this->redirect('index', "page/{$_GET['page']}");
			} else {
				$this -> error("删除商品失败!", 3, "index");
			} 
		}

    <td><a href="<{$url}>/mod/id/<{$good.id}>">修改</a>/<a onclick="return confirm('你确定要删除<{$good.name}>吗?')" href="<{$url}>/del/id/<{$good.id}>/page/<{$page}>">删除</a></td>

##分页功能
###Views
[admin/views/default/goods/index.tpl]
    <td colspan="6" align="right"><{$fpage}></td>

###Controls
[admin/controls/goods.class.php (index)]

    function index() {
			$goods = D('goods');
			$page = new Page($goods->total(), 10);
			$this->assign('goods', $goods->field('id, name, price, num, ptime')->limit($page->limit)->select());
			$this->assign('fpage', $page->fpage());
			$this->assign('page', $page->page);
			$this->display();
    
    }
 
