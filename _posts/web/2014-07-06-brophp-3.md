---
layout: post
title: Brophp教程笔记3-后台管理系统商品管理模块
description: ""
categories: [web]
tags: [php]
---

#商品管理模块：
首先看看后台首页里的商品管理部分（增删改查）：

    <li> 
        <h3>商品管理</h3> 
        <ul>
            <li><a href="<{$app}>/goods/add"  target="right">添加商品</a></li>
            <li><a href="<{$app}>/goods" target="right">编辑商品</a></li>
        </ul>
    <li>        
    
<{$app}> //表示当前应用的主入口文件，即admin.php
<{$app}>/goods/add  //访问goods模块下的添加操作
<{$app}>/goods  //访问goods模块下的index操作，即查询操作

除了增加和查询操作还应该有修改和删除，不过修改和删除一般针对特定数据，也就是说必须在查询界面(或编辑界面)里添加这两个功能。

数据表文件如下：

    CREATE TABLE xs_goods(
        id INT UNSIGNED NOT NULL AUTO_INCREMENT,
        name VARCHAR(50) NOT NULL DEFAULT '',
        price DOUBLE NOT NULL DEFAULT 0.00,
        ptime INT NOT NULL DEFAULT 0,
        num INT NOT NULL DEFAULT 0,
        pic CHAR(40) NOT NULL DEFAULT '',
        desn TEXT,
        INDEX goods_name(name),
        INDEX goods_price(price),
        PRIMARY KEY(id)
    );

##增加商品
[admin/controls/goods.class.php (add)]

		//要添加界面
		function add() {
			$this->display();
		}

[admin/views/default/goods/add.tpl]

    <{include "public/header.tpl"}>  //加载头部模板 public目录下
    <h1>添加商品</h1>
    <form action="<{$url}>/insert" method="post">
        商品名称： <input type="text" name="name" value="" /><br>
        商品价格：<input type="text" name="price" value="" /><br>
        商品数量: <input type="text" name="num" value="" /> <br>
        商品图片：<input type="file" name="uppic" value="" /><br>
        商品介绍：<textarea name="desn" cols="40" rows="8"></textarea> <br>

        <input type="submit" value="添加商品"><br> 
    </form>

    <{include file="public/footer.tpl"}>  //加载尾部模板 public目录下


    <form action="<{$url}>/insert" method="post">

表单提交到当前模块下的insert操作，将商品信息插入数据库。

[admin/controls/goods.class.php (insert)]

		function insert() {
			
			$goods = D("goods");//初始化goods数据表模块
			$_POST['ptime'] = time();//获取本机时间
			if($goods->insert()) {//判断是否插入，默认数据在$_POST[]中。
				$this->success("添加商品成功!", 1, "index"); //成功则跳转到index操作下
			} else {
				$this->error("添加商品失败!", 3, "add");//失败则跳转到add操作下。
			}
		}

##查询商品界面（编辑界面）

[admin/controls/goods.class.php (index)]

		//查询
		function index() {
	    	$goods = D('goods');
            $this->assign('goods', $goods->field('id, name, price, num, ptime')->select());//给smart模板分配变量
			$this->display();
		}
		
[admin/views/default/goods/index.tpl]

    <{include "public/header.tpl"}>

    <table border="1" width="800" align="center">
    <form action="<{$url}>/del" method="post" onsubmit="return confirm('你确定要删除这些商品吗?')">
        <caption><h1>商品列表</h1></caption>

        <tr>
            <th>&nbsp;</th> <th>ID</th> <th>商品名称</th> <th>商品价格</th><th>数量</th><th>添加时间</th><th>操作</th>
        </tr>
        
        <{forech $goods as $good}> 
            <tr>
                <td><input type="checkbox" name="id[]" value="<{$good.id}>"></td>
                <td><{$good.id}></td>
                <td><{$good.name}></td>
                <td>￥<{$good.price}></td>
                <td><{$good.num}></td>
                <td><{$good.ptime|date_format:"%Y-%m-%d"}></td>
                <td><a href="<{$url}>/mod/id/<{$good.id}>">修改</a>/<a onclick="return confirm('你确定要删除<{$good.name}>吗?')" href="<{$url}>/del/id/<{$good.id}>">删除</a></td>
            </tr>
        <{foreachelse}>
            <tr> <td colspan="7">没有商品 </td></tr>
        <{/foreach}>

        <tr>
            <td colspan="7"><input type="submit" name="del" value="删除"></td>
        </tr>
    </form>
    </table>

    <{include "public/footer.tpl"}>

其中：
    <{forech $goods as $good}> //模板的遍历语句，遍历数据

    <td><{$good.ptime|date_format:"%Y-%m-%d"}></td> //date_format:"%Y-%m-%d" 变量修改器
    
##修改商品

    <td><a href="<{$url}>/mod/id/<{$good.id}>">修改</a>  //点击修改按钮，讲id传送到当前模块下的mod操作。

此处的ID是用作身份识别。
[admin/controls/goods.class.php (mod)]

		//要修改界面
		function mod() {
			$this->assign(D("goods")->find($_GET['id']));//find查询到整条数据，并且是数组的形式。注意此处没有分配模板变量名，默认使用数组名。
			$this->display();
		}
		
[admin/views/default/goods/mod.tpl]

    <{include "public/header.tpl"}>
    <h1>修改商品</h1>
    <form action="<{$url}>/update" method="post">
        <input type="hidden" name="id" value="<{$id}>">
        商品名称： <input type="text" name="name" value="<{$name}>" /><br>
        商品价格：<input type="text" name="price" value="<{$price}>" /><br>
        商品数量: <input type="text" name="num" value="<{$num}>" /> <br>
        商品图片：<input type="file" name="uppic" value="" /><br>
        商品介绍：<textarea name="desn" cols="40" rows="8"><{$desn}></textarea> <br>

        <input type="submit" value="修改商品"><br> 
    </form>

    <{include file="public/footer.tpl"}>
    
注意下面这条语句：
    <input type="hidden" name="id" value="<{$id}>">

因为表单要提交到当前模块下的update操作，需要对数据库进行更新，所以必须传入一个隐藏ID。 
参加： 
    <form action="<{$url}>/update" method="post"> 
[admin/controls/goods.class.php (update)] 
    
		function update() {
			$goods = D("goods");

			if($goods ->update()) {
				$this->success("修改成功!", 1, "index");
			} else {
				$this->error("修改失败", 3, "goods/mod/id/{$_POST['id']}");
			}
		}

    if($goods ->update()) //默认数据在$_POST[] 
    
	$this->error("修改失败", 3, "goods/mod/id/{$_POST['id']}");//修改失败，仍然要把id传入mod操作

##删除商品：
单个删除：(GET方式传入单个id)

    <a onclick="return confirm('你确定要删除<{$good.name}>吗?')" href="<{$url}>/del/id/<{$good.id}>">删除</a></td>

多个删除：(POST方式以数组方式传入多个ID) 

    <form action="<{$url}>/del" method="post" onsubmit="return confirm('你确定要删除这些商品吗?')">
    <td><input type="checkbox" name="id[]" value="<{$good.id}>"></td>

[admin/controls/goods.class.php (update)] 

		//删除
		function del() {
			
			$goods = D("goods");

	
		//p($_GET['id'], $_POST['id']);

			$id = !empty($_POST['id']) ? $_POST['id'] : $_GET['id'];

			if($goods->where($id)->delete()) {
				$this->redirect('index');//直接重定向到index查询页面，或编辑页面。
			} else {
				$this -> error("删除商品失败!", 3, "index");
			} 
		}
		

