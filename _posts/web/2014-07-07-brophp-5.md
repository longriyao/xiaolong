---
layout: post
title: Brophp教程笔记5-无限分类
description: ""
categories: [web]
tags: [php]
---
#无限分类
##原理概述：
无限分类有两种方式，点击式和列表式。

点击式对应的数据表：

    ID	PID	NAME	DESN
    1	0	Soft	
    2	0	net	
    3	1	java	
    4	1	php	
    5	3	J2se	
    6	3	J2ee	
    7	4	smarty	
    8	4	brophp	
    9	8	xmlyz	
    10	6	jsp	
    
通过父类PID。

列表式：

    ID	pid	path	NAME	DESN
    1	0	0	Soft	
    2	0	0	net	
    3	1	0-1	java	
    4	1	0-1	php	
    5	3	0-1-3	J2se	
    6	3	0-1-3	J2ee	
    7	4	0-1-4	smarty	
    8	4	0-1-4	brophp	
    9	8	0-1-4-8	xmlyz	
    10	6	0-1-3-6	jsp	
    
列表式的实现需要两个步骤。排序和缩进。

第一步：排序

    cat
    ID	pid	path	NAME	DESN
    1	0	0-1	    Soft	
    2	0	0-2	    net	
    3	1	0-1-3	java	
    4	1	0-1-4	php	
    5	3	0-1-3-5	J2se	
    6	3	0-1-3-6	J2ee	
    7	4	0-1-4-7	smarty	
    8	4	0-1-4-8	brophp	
    9	8	0-1-4-8-9	xmlyz	
    10	6	0-1-3-6-10	jsp	

Select id, concat(path, ‘-’, id) as abspath, name from cat order by abspath,id;

    Soft
    Java
    J2se
    J2ee
    jsp
    php
    smarty
    brophp
    xmlyz
    

第二步：缩进

    Soft
        Java
            J2se
            J2ee
                jsp
        php
            smarty
            brophp
                xmlyz
    net

按照数据表中的path字段。有几个短横就缩进几次。但是我们不能直接算出有几个短横。不过可以通过字符串处理，用“-”来切割我们取出的abspath字段。例如：
    
    abspath (path+id)
    10	6	0-1-3-6-10	jsp	

$num = count(explode('-', $row['abspath']))-2;
//num=5-2=3  //即path字段的短横数目。

##实现方式：
分类作为下来菜单<selecte>本应属于Views部分，不过因为这个分类功能非常常用，我们可以把它模块化，写成一个Model。需要用的时候直接调用。

###Model
[admin/model/cat.class.php]

<?php
	class Cat {
	    //第一个参数是name名称，第二个参数是值。
		function selectform($name="pid", $pid=0) {
			$data = $this->field('id, concat(path, "-", id) as abspath, name')->order('abspath, id')->select();
			
			$html = '';
		    //name名称必须有否则修改之后无法正常提交表单到数据库	
			$html .= '<select name="'.$name.'">';

			$html .= '<option value="0">--根分类--</option>';
			foreach($data as $row) {
				//数量
				$num = count(explode('-', $row['abspath']))-2;
				//一个"-" 变成8个空格的缩进
				$space =  str_repeat("|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;", $num);
				$selected = ($pid == $row['id']) ? "selected" : '';
				$html .='<option '.$selected.' value="'.$row['id'].'">'.$space.'|-'.$row['name'].'</option>';
			}

			$html .='</select>';

			return $html;
		}
	}

###Controls
[admin/controls/goods.class.php]

		//要修改界面
		function mod() {
			
			$goods=D("goods")->find($_GET['id']);

			$this->assign("select", D('cat')->selectform('cid', $goods['cid']));

			$this->assign($goods);

			$this->display();
		}

###Views
[admin/views/default/goods/mod.tpl]

    商品分类: <{$select}><br>
    

